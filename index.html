<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Classe 2^ F </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 800px;
        }
        .tab-button.active {
            background-color: #fff;
            color: #1a202c;
            border-bottom: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex items-center justify-center">
<div id="app" class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 sm:p-8 rounded-t-2xl flex justify-between items-center">
        <div>
            <h1 id="welcome-message" class="text-3xl sm:text-4xl font-bold mb-1">Benvenuto!</h1>
            <p class="text-lg opacity-90">Gestisci la classe 2^ F - Istituto Gozzadini, Castenaso</p>
        </div>
        <div id="user-info" class="text-right text-sm opacity-80">
            <p>Caricamento...</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="flex border-b border-gray-200 overflow-x-auto whitespace-nowrap">
        <button id="tab-home" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200 active">Home</button>
        <button id="tab-finanze" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200">Fondo Cassa</button>
        <button id="tab-contatti" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200">Contatti</button>
        <button id="tab-avvisi" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200">Bacheca Avvisi</button>
        <button id="tab-whatsapp" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200">Community WA</button>
        <button id="tab-users" class="tab-button flex-1 py-4 px-2 sm:px-4 text-center text-sm sm:text-base font-semibold text-gray-600 transition-colors duration-200 hidden">Gestione Utenti</button>
    </div>

    <!-- Main Content Area -->
    <div class="p-4 sm:p-8">

        <!-- Home Section -->
        <div id="section-home" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Panoramica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-6 rounded-xl shadow-inner flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-blue-700">Saldo Fondo Cassa</h3>
                        <p id="total-balance" class="text-4xl font-bold mt-2 text-blue-900">€ 0.00</p>
                    </div>
                    <p class="text-sm mt-4 text-blue-600">Gestisci entrate e uscite dalla sezione "Fondo Cassa".</p>
                </div>
                <div class="bg-indigo-50 p-6 rounded-xl shadow-inner flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-indigo-700">Prossime Attività</h3>
                        <ul id="activity-list" class="mt-2 text-indigo-900 space-y-2">
                            <li class="p-2 bg-indigo-100 rounded-lg text-sm">Nessuna attività pianificata.</li>
                        </ul>
                    </div>
                    <p class="text-sm mt-4 text-indigo-600">Aggiungi nuove attività nella sezione "Avvisi".</p>
                </div>
            </div>
        </div>

        <!-- Finanze Section -->
        <div id="section-finanze" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestione Fondo Cassa</h2>
            
            <!-- Button for Satispay integration -->
            <a href="https://web.satispay.com/download/qrcode/S6Y-SVN--F18FC4E1-6E7F-458D-B821-88ACA56CA3CA?locale=it" target="_blank" class="w-full mb-6 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 flex items-center justify-center">
                Paga con Satispay
            </a>

            <!-- Form for adding transactions -->
            <form id="transaction-form" class="bg-white p-6 rounded-xl shadow-md mb-6 border border-gray-200 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Aggiungi Movimento</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="transaction-type" name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="entry">Entrata (+)</option>
                            <option value="exit">Uscita (-)</option>
                        </select>
                    </div>
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Importo (€)</label>
                        <input type="number" id="transaction-amount" name="amount" required step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descrizione</label>
                    <input type="text" id="transaction-description" name="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Aggiungi Movimento
                </button>
            </form>

            <!-- Transactions list -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Storico Movimenti</h3>
                <div id="transactions-history" class="space-y-4">
                    <p class="text-gray-500 text-center">Nessun movimento registrato.</p>
                </div>
            </div>
        </div>
        
        <!-- Contatti Section -->
        <div id="section-contatti" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Rubrica Contatti</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p id="auth-message-contacts" class="text-sm text-gray-600 mb-4"></p>
                <form id="contact-form" class="mb-6 hidden">
                    <div class="space-y-4">
                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="text-lg font-semibold text-gray-700">Dati Alunno</h4>
                            <label for="student-name" class="block text-sm font-medium text-gray-700 mt-2">Nome Alunno</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <label for="student-phone" class="block text-sm font-medium text-gray-700 mt-2">Numero di Telefono Alunno (opzionale)</label>
                            <input type="tel" id="student-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>

                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="text-lg font-semibold text-gray-700">Dati Genitore 1</h4>
                            <label for="parent1-name" class="block text-sm font-medium text-gray-700 mt-2">Nome Genitore</label>
                            <input type="text" id="parent1-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <label for="parent1-phone" class="block text-sm font-medium text-gray-700 mt-2">Numero di Telefono</label>
                            <input type="tel" id="parent1-phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <label for="parent1-email" class="block text-sm font-medium text-gray-700 mt-2">Email (opzionale)</label>
                            <input type="email" id="parent1-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>

                        <div class="border-b border-gray-200 pb-4">
                            <h4 class="text-lg font-semibold text-gray-700">Dati Genitore 2 (opzionale)</h4>
                            <label for="parent2-name" class="block text-sm font-medium text-gray-700 mt-2">Nome Genitore</label>
                            <input type="text" id="parent2-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <label for="parent2-phone" class="block text-sm font-medium text-gray-700 mt-2">Numero di Telefono</label>
                            <input type="tel" id="parent2-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <label for="parent2-email" class="block text-sm font-medium text-gray-700 mt-2">Email (opzionale)</label>
                            <input type="email" id="parent2-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>

                        <div>
                            <label for="contact-notes" class="block text-sm font-medium text-gray-700">Note (opzionale)</label>
                            <textarea id="contact-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>

                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-2 px-4 mt-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Aggiungi Contatto
                    </button>
                </form>
                <div id="contact-list" class="space-y-4">
                    <p class="text-gray-500 text-center">Nessun contatto aggiunto.</p>
                </div>
            </div>
        </div>

        <!-- Bacheca Avvisi Section -->
        <div id="section-avvisi" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Bacheca Avvisi e Attività</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p id="auth-message-notices" class="text-sm text-gray-600 mb-4"></p>
                <form id="notice-form" class="mb-6 hidden">
                    <div class="mb-4">
                        <label for="notice-text" class="block text-sm font-medium text-gray-700">Nuovo Avviso</label>
                        <textarea id="notice-text" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Pubblica Avviso
                    </button>
                </form>
                <div id="notices-board" class="space-y-4">
                    <p class="text-gray-500 text-center">Nessun avviso pubblicato.</p>
                </div>
            </div>
        </div>

        <!-- WhatsApp Community Section -->
        <div id="section-whatsapp" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Community WhatsApp</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 text-center">
                <p class="text-lg mb-4 text-gray-700">Entra nella community WhatsApp per comunicazioni rapide e dirette!</p>
                <a href="il_tuo_link_whatsapp" target="_blank" class="inline-block w-full sm:w-auto py-3 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400">
                    Vai alla Chat
                </a>
            </div>
        </div>

        <!-- Gestione Utenti Section -->
        <div id="section-users" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestione Utenti</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <p id="user-management-message" class="text-sm text-gray-600 mb-4">Caricamento utenti...</p>
                <div id="users-list" class="space-y-4">
                </div>
            </div>
        </div>
        
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, getDocs, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Hardcoded data for initial setup
    const initialContacts = [
        {
            studentName: 'Liam Lucas Fina',
            studentPhone: '',
            parent1: { name: 'Salvatore Willy Fina', phone: 'Inserisci numero di Salvatore', email: 'Inserisci email di Salvatore' },
            parent2: { name: 'Mikela Quaranta', phone: 'Inserisci numero di Mikela', email: 'Inserisci email di Mikela' },
            notes: 'Genitori di Liam',
            timestamp: new Date()
        }
    ];

    let db;
    let auth;
    let userId;
    let userHasWriteAccess = false;
    let allUsers = [];
    let adminUsers = [];
    let currentUserName = '';

    // ---- Utility functions ----
    function formatDate(date) {
        if (!date) return 'Data non disponibile';
        const d = new Date(date.seconds * 1000);
        return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // ---- UI and Authentication ----
    const userInfoEl = document.getElementById('user-info');
    const welcomeMessageEl = document.getElementById('welcome-message');
    const transactionForm = document.getElementById('transaction-form');
    const contactForm = document.getElementById('contact-form');
    const noticeForm = document.getElementById('notice-form');
    const authMessageContactsEl = document.getElementById('auth-message-contacts');
    const authMessageNoticesEl = document.getElementById('auth-message-notices');
    const usersTab = document.getElementById('tab-users');
    const usersListEl = document.getElementById('users-list');

    function showUIForAuthorizedUsers() {
        if (userHasWriteAccess) {
            transactionForm.classList.remove('hidden');
            noticeForm.classList.remove('hidden');
            contactForm.classList.remove('hidden');
            authMessageContactsEl.textContent = 'Puoi inserire, modificare o eliminare i contatti.';
            authMessageNoticesEl.textContent = 'Puoi inserire, modificare o eliminare gli avvisi.';
            usersTab.classList.remove('hidden');
        } else {
            transactionForm.classList.add('hidden');
            noticeForm.classList.add('hidden');
            contactForm.classList.add('hidden');
            authMessageContactsEl.textContent = 'Questa rubrica è visualizzabile da tutti. Solo i rappresentanti di classe possono aggiungere o modificare i contatti.';
            authMessageNoticesEl.textContent = 'Questa bacheca è visualizzabile da tutti. Solo i rappresentanti di classe possono pubblicare avvisi.';
            usersTab.classList.add('hidden');
        }
    }

    async function initFirebase() {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfoEl.innerHTML = `<p>ID utente:</p><p class="text-xs font-mono break-all">${userId}</p>`;
                    
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDoc = await getDoc(userDocRef);
                    if (!userDoc.exists()) {
                        let nameToAssign = `Utente Anonimo ${userId.substring(0, 5)}`;
                        if (userId === 'default-user-id-1') {
                            nameToAssign = 'Salvatore Willy Fina';
                        } else if (userId === 'default-user-id-2') {
                            nameToAssign = 'Mikela Quaranta';
                        }
                        currentUserName = nameToAssign;
                        await setDoc(userDocRef, {
                            uid: userId,
                            name: nameToAssign,
                            firstAccess: serverTimestamp()
                        });
                        welcomeMessageEl.textContent = `Benvenuto ${nameToAssign}!`;
                    } else {
                        const userData = userDoc.data();
                        currentUserName = userData.name;
                        welcomeMessageEl.textContent = `Benvenuto ${currentUserName}!`;
                    }
                    
                    const adminCheckDocRef = doc(db, `artifacts/${appId}/public/data/admin_check`, 'is_admin_set');
                    const adminCheckDoc = await getDoc(adminCheckDocRef);

                    if (!adminCheckDoc.exists()) {
                        const adminDocRef = doc(db, `artifacts/${appId}/public/data/admins`, 'default-user-id-1');
                        await setDoc(adminDocRef, { timestamp: serverTimestamp() });
                        await setDoc(adminCheckDocRef, { set: true });

                        await addDoc(collection(db, `artifacts/${appId}/public/data/contacts`), {
                            studentName: 'Liam Lucas Fina',
                            studentPhone: '',
                            parent1: { name: 'Salvatore Willy Fina', phone: '', email: '' },
                            parent2: { name: 'Mikela Quaranta', phone: '', email: '' },
                            notes: 'Genitori di Liam',
                            timestamp: serverTimestamp()
                        });
                    }

                    setupFirestoreListeners();
                } else {
                    console.error("Non è stato possibile autenticare l'utente.");
                    userInfoEl.innerHTML = '<p class="text-sm">Errore di autenticazione.</p>';
                }
            });
        } catch (error) {
            console.error("Errore nell'inizializzazione di Firebase:", error);
            userInfoEl.innerHTML = `<p class="text-sm">Errore di connessione.</p>`;
        }
    }

    // ---- Firestore Listeners ----
    function setupFirestoreListeners() {
        if (!db) return;

        const adminsRef = collection(db, `artifacts/${appId}/public/data/admins`);
        onSnapshot(adminsRef, (snapshot) => {
            adminUsers = snapshot.docs.map(doc => doc.id);
            userHasWriteAccess = adminUsers.includes(userId);
            showUIForAuthorizedUsers();
            renderUsers();
        }, (error) => {
            console.error("Errore nella lettura degli amministratori:", error);
        });

        const allUsersRef = collection(db, `artifacts/${appId}/public/data/users`);
        onSnapshot(allUsersRef, (snapshot) => {
            allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUsers();
        }, (error) => {
            console.error("Errore nella lettura di tutti gli utenti:", error);
        });

        const transactionsRef = collection(db, `artifacts/${appId}/public/data/transactions`);
        onSnapshot(transactionsRef, (snapshot) => {
            const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTransactions(transactions);
            updateTotalBalance(transactions);
        }, (error) => {
            console.error("Errore nella lettura delle transazioni:", error);
        });

        const contactsRef = collection(db, `artifacts/${appId}/public/data/contacts`);
        onSnapshot(contactsRef, (snapshot) => {
            const contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderContacts(contacts);
        }, (error) => {
            console.error("Errore nella lettura dei contatti:", error);
        });

        const noticesRef = collection(db, `artifacts/${appId}/public/data/notices`);
        onSnapshot(noticesRef, (snapshot) => {
            const notices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderNotices(notices);
            renderActivitiesOnHome(notices);
        }, (error) => {
            console.error("Errore nella lettura degli avvisi:", error);
        });
    }
    
    // ---- Tab and UI Management ----
    const sections = {
        'home': document.getElementById('section-home'),
        'finanze': document.getElementById('section-finanze'),
        'contatti': document.getElementById('section-contatti'),
        'avvisi': document.getElementById('section-avvisi'),
        'whatsapp': document.getElementById('section-whatsapp'),
        'users': document.getElementById('section-users')
    };
    const tabs = {
        'home': document.getElementById('tab-home'),
        'finanze': document.getElementById('tab-finanze'),
        'contatti': document.getElementById('tab-contatti'),
        'avvisi': document.getElementById('tab-avvisi'),
        'whatsapp': document.getElementById('tab-whatsapp'),
        'users': document.getElementById('tab-users')
    };

    function showSection(sectionId) {
        Object.values(sections).forEach(section => section.classList.add('hidden'));
        sections[sectionId].classList.remove('hidden');

        Object.values(tabs).forEach(tab => tab.classList.remove('active'));
        tabs[sectionId].classList.add('active');
    }

    Object.keys(tabs).forEach(sectionId => {
        tabs[sectionId].addEventListener('click', () => showSection(sectionId));
    });

    // ---- Transaction Management (Fondo Cassa) ----
    const totalBalanceEl = document.getElementById('total-balance');
    const transactionsHistoryEl = document.getElementById('transactions-history');

    function updateTotalBalance(transactions) {
        const total = transactions.reduce((sum, t) => {
            const amount = parseFloat(t.amount);
            return t.type === 'entry' ? sum + amount : sum - amount;
        }, 0);
        totalBalanceEl.textContent = `€ ${total.toFixed(2)}`;
        totalBalanceEl.classList.remove('text-blue-900', 'text-red-600', 'text-green-600');
        if (total > 0) {
            totalBalanceEl.classList.add('text-green-600');
        } else if (total < 0) {
            totalBalanceEl.classList.add('text-red-600');
        } else {
            totalBalanceEl.classList.add('text-blue-900');
        }
    }

    function renderTransactions(transactions) {
        if (transactions.length === 0) {
            transactionsHistoryEl.innerHTML = '<p class="text-gray-500 text-center">Nessun movimento registrato.</p>';
            return;
        }
        
        const sortedTransactions = transactions.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        transactionsHistoryEl.innerHTML = sortedTransactions.map((t) => {
            const isEntry = t.type === 'entry';
            const sign = isEntry ? '+' : '-';
            const colorClass = isEntry ? 'text-green-600' : 'text-red-600';
            const deleteButton = userHasWriteAccess ? 
                `<button onclick="deleteTransaction('${t.id}')" class="p-1 rounded-full text-red-400 hover:text-red-600 transition-colors duration-200" aria-label="Elimina movimento">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>` : '';

            return `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 shadow-sm">
                    <div>
                        <p class="font-medium text-gray-800">${t.description}</p>
                        <p class="text-sm text-gray-500">${formatDate(t.timestamp)}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold ${colorClass}">${sign}€ ${parseFloat(t.amount).toFixed(2)}</span>
                        ${deleteButton}
                    </div>
                </div>
            `;
        }).join('');
    }

    window.deleteTransaction = async function(id) {
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per eliminare questo elemento.");
            return;
        }
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/transactions`, id));
        } catch (error) {
            console.error("Errore nell'eliminazione della transazione:", error);
        }
    }

    transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per aggiungere questo elemento.");
            return;
        }
        const type = document.getElementById('transaction-type').value;
        const amount = parseFloat(document.getElementById('transaction-amount').value);
        const description = document.getElementById('transaction-description').value;
        
        if (amount > 0) {
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/transactions`), {
                    type,
                    amount,
                    description,
                    timestamp: serverTimestamp()
                });
                transactionForm.reset();
            } catch (error) {
                console.error("Errore nell'aggiunta della transazione:", error);
            }
        }
    });

    // ---- Contact Management (Rubrica) ----
    const contactListEl = document.getElementById('contact-list');

    function renderContacts(contacts) {
        if (contacts.length === 0) {
            contactListEl.innerHTML = '<p class="text-gray-500 text-center">Nessun contatto aggiunto.</p>';
            return;
        }

        const sortedContacts = contacts.sort((a, b) => a.studentName.localeCompare(b.studentName));
        contactListEl.innerHTML = sortedContacts.map((contact) => {
            const deleteButton = userHasWriteAccess ? 
                `<button onclick="deleteContact('${contact.id}')" class="p-1 rounded-full text-red-400 hover:text-red-600 transition-colors duration-200" aria-label="Elimina contatto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>` : '';

            return `
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-100 shadow-sm mb-4">
                    <h4 class="font-bold text-lg mb-2 text-gray-800">Alunno: ${contact.studentName}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-medium text-gray-700">Genitore 1:</p>
                            <p>${contact.parent1.name}</p>
                            <p><a href="tel:${contact.parent1.phone}" class="text-blue-500 hover:underline">${contact.parent1.phone}</a></p>
                            ${contact.parent1.email ? `<p><a href="mailto:${contact.parent1.email}" class="text-blue-500 hover:underline">${contact.parent1.email}</a></p>` : ''}
                        </div>
                        ${contact.parent2.name ? `
                        <div>
                            <p class="font-medium text-gray-700">Genitore 2:</p>
                            <p>${contact.parent2.name}</p>
                            <p><a href="tel:${contact.parent2.phone}" class="text-blue-500 hover:underline">${contact.parent2.phone}</a></p>
                            ${contact.parent2.email ? `<p><a href="mailto:${contact.parent2.email}" class="text-blue-500 hover:underline">${contact.parent2.email}</a></p>` : ''}
                        </div>` : ''}
                    </div>
                    ${contact.studentPhone ? `<p class="mt-4 text-sm"><span class="font-medium text-gray-700">Telefono Alunno:</span> <a href="tel:${contact.studentPhone}" class="text-blue-500 hover:underline">${contact.studentPhone}</a></p>` : ''}
                    ${contact.notes ? `<p class="mt-2 text-sm text-gray-600"><span class="font-medium text-gray-700">Note:</span> ${contact.notes}</p>` : ''}
                    <div class="flex justify-end mt-4">
                        ${deleteButton}
                    </div>
                </div>
            `;
        }).join('');
    }

    window.deleteContact = async function(id) {
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per eliminare questo elemento.");
            return;
        }
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/contacts`, id));
        } catch (error) {
            console.error("Errore nell'eliminazione del contatto:", error);
        }
    }

    contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per aggiungere questo elemento.");
            return;
        }
        const studentName = document.getElementById('student-name').value;
        const studentPhone = document.getElementById('student-phone').value;
        const parent1Name = document.getElementById('parent1-name').value;
        const parent1Phone = document.getElementById('parent1-phone').value;
        const parent1Email = document.getElementById('parent1-email').value;
        const parent2Name = document.getElementById('parent2-name').value;
        const parent2Phone = document.getElementById('parent2-phone').value;
        const parent2Email = document.getElementById('parent2-email').value;
        const notes = document.getElementById('contact-notes').value;
        
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/contacts`), {
                studentName,
                studentPhone,
                parent1: { name: parent1Name, phone: parent1Phone, email: parent1Email },
                parent2: { name: parent2Name, phone: parent2Phone, email: parent2Email },
                notes,
                timestamp: serverTimestamp()
            });
            contactForm.reset();
        } catch (error) {
            console.error("Errore nell'aggiunta del contatto:", error);
        }
    });

    // ---- Notice and Activity Management (Bacheca Avvisi) ----
    const noticesBoardEl = document.getElementById('notices-board');
    const activityListEl = document.getElementById('activity-list');

    function renderNotices(notices) {
        if (notices.length === 0) {
            noticesBoardEl.innerHTML = '<p class="text-gray-500 text-center">Nessun avviso pubblicato.</p>';
            return;
        }

        const sortedNotices = notices.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        noticesBoardEl.innerHTML = sortedNotices.map((notice) => {
            const deleteButton = userHasWriteAccess ? 
                `<button onclick="deleteNotice('${notice.id}')" class="p-1 rounded-full text-red-400 hover:text-red-600 transition-colors duration-200" aria-label="Elimina avviso">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>` : '';
            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 shadow-sm">
                    <div class="flex justify-between items-start">
                        <p class="text-gray-800">${notice.text}</p>
                        ${deleteButton}
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Pubblicato il: ${formatDate(notice.timestamp)}</p>
                </div>
            `;
        }).join('');
    }

    function renderActivitiesOnHome(notices) {
        const sortedNotices = notices.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        if (sortedNotices.length === 0) {
            activityListEl.innerHTML = `<li class="p-2 bg-indigo-100 rounded-lg text-sm">Nessuna attività pianificata.</li>`;
        } else {
            activityListEl.innerHTML = sortedNotices.slice(0, 3).map(notice => {
                return `<li class="p-2 bg-indigo-100 rounded-lg text-sm">${notice.text} (${formatDate(notice.timestamp)})</li>`;
            }).join('');
        }
    }

    window.deleteNotice = async function(id) {
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per eliminare questo elemento.");
            return;
        }
        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/notices`, id));
        } catch (error) {
            console.error("Errore nell'eliminazione dell'avviso:", error);
        }
    }

    noticeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per aggiungere questo elemento.");
            return;
        }
        const text = document.getElementById('notice-text').value;
        
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/notices`), {
                text,
                timestamp: serverTimestamp()
            });
            noticeForm.reset();
        } catch (error) {
            console.error("Errore nell'aggiunta dell'avviso:", error);
        }
    });
    
    // ---- User Management ----
    window.toggleAdmin = async function(targetUid) {
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per modificare i ruoli utente.");
            return;
        }

        const isAdmin = adminUsers.includes(targetUid);
        const adminDocRef = doc(db, `artifacts/${appId}/public/data/admins`, targetUid);

        try {
            if (isAdmin) {
                await deleteDoc(adminDocRef);
            } else {
                await setDoc(adminDocRef, {
                    uid: targetUid,
                    timestamp: serverTimestamp()
                });
            }
        } catch (error) {
            console.error("Errore nella modifica dei permessi utente:", error);
        }
    }

    window.updateUserName = async function(userIdToUpdate) {
        if (!userHasWriteAccess) {
            console.warn("Non hai i permessi per modificare i nomi utente.");
            return;
        }
        const newName = document.getElementById(`name-input-${userIdToUpdate}`).value;
        if (newName) {
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/users`, userIdToUpdate), { name: newName }, { merge: true });
                console.log(`Nome utente per ${userIdToUpdate} aggiornato a ${newName}.`);
            } catch (error) {
                console.error("Errore nell'aggiornamento del nome utente:", error);
            }
        }
    }

    function renderUsers() {
        if (allUsers.length === 0) {
            usersListEl.innerHTML = '<p class="text-gray-500 text-center">Nessun utente ha ancora effettuato l\'accesso.</p>';
            return;
        }
        
        usersListEl.innerHTML = allUsers.map(user => {
            const isAdmin = adminUsers.includes(user.id);
            const buttonText = isAdmin ? 'Rimuovi Admin' : 'Promuovi ad Admin';
            const buttonColor = isAdmin ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
            const disableButton = (userId === user.id) ? 'disabled' : '';

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800 break-words">Nome: ${user.name}</p>
                        <p class="text-sm text-gray-500 break-all font-mono">ID: ${user.id}</p>
                    </div>
                    <div class="sm:ml-4 flex flex-col space-y-2 sm:space-y-0 sm:space-x-2">
                        <div class="flex items-center">
                            <input type="text" id="name-input-${user.id}" placeholder="Nuovo nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm p-1">
                            <button onclick="updateUserName('${user.id}')" class="ml-2 py-1 px-3 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200">Salva</button>
                        </div>
                        <button onclick="toggleAdmin('${user.id}')" class="py-2 px-4 rounded-md text-sm font-medium text-white transition-colors duration-200 ${buttonColor}" ${disableButton}>
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---- Initial rendering ----
    document.addEventListener('DOMContentLoaded', initFirebase);
</script>

</body>
</html>
